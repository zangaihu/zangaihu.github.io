<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>RocketMQ | Hexo</title><meta name="description" content="什么是RokcetMQ消息队列 RocketMQ 版是阿里云基于 Apache RocketMQ 构建的低延迟、高并发、高可用、高可靠的分布式消息中间件。消息队列 RocketMQ 版既可为分布式应用系统提供异步解耦和削峰填谷的能力，同时也具备互联网应用所需的海量消息堆积、高吞吐、可靠重试等特性。 应用场景 削峰填谷 诸如秒杀、抢红包、企业开门红等大型活动时皆会带来较高的流量脉冲，或因没做相应的保"><meta name="keywords" content="RocketMQ,中间件,消息队列"><meta name="author" content="zangaihu"><meta name="copyright" content="zangaihu"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/avatar.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="RocketMQ"><meta name="twitter:description" content="什么是RokcetMQ消息队列 RocketMQ 版是阿里云基于 Apache RocketMQ 构建的低延迟、高并发、高可用、高可靠的分布式消息中间件。消息队列 RocketMQ 版既可为分布式应用系统提供异步解耦和削峰填谷的能力，同时也具备互联网应用所需的海量消息堆积、高吞吐、可靠重试等特性。 应用场景 削峰填谷 诸如秒杀、抢红包、企业开门红等大型活动时皆会带来较高的流量脉冲，或因没做相应的保"><meta name="twitter:image" content="http://yoursite.com/img/rocketmq.jpg"><meta property="og:type" content="article"><meta property="og:title" content="RocketMQ"><meta property="og:url" content="http://yoursite.com/2020/06/02/RocketMQ/"><meta property="og:site_name" content="Hexo"><meta property="og:description" content="什么是RokcetMQ消息队列 RocketMQ 版是阿里云基于 Apache RocketMQ 构建的低延迟、高并发、高可用、高可靠的分布式消息中间件。消息队列 RocketMQ 版既可为分布式应用系统提供异步解耦和削峰填谷的能力，同时也具备互联网应用所需的海量消息堆积、高吞吐、可靠重试等特性。 应用场景 削峰填谷 诸如秒杀、抢红包、企业开门红等大型活动时皆会带来较高的流量脉冲，或因没做相应的保"><meta property="og:image" content="http://yoursite.com/img/rocketmq.jpg"><meta property="article:published_time" content="2020-06-02T07:03:34.000Z"><meta property="article:modified_time" content="2020-06-02T09:30:06.671Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="canonical" href="http://yoursite.com/2020/06/02/RocketMQ/"><link rel="next" title="MongoDB基本操作" href="http://yoursite.com/2020/05/25/MongoDB%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5/js/md5.min.js"></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: {"languages":{"author":"作者: zangaihu","link":"链接: ","source":"来源: Hexo","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: {"bookmark":{"message_prev":"按","message_next":"键将本页加入书签"},"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: true,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">6</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">5</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">3</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#什么是RokcetMQ"><span class="toc-number">1.</span> <span class="toc-text">什么是RokcetMQ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#应用场景"><span class="toc-number">2.</span> <span class="toc-text">应用场景</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#系统部署架构"><span class="toc-number">3.</span> <span class="toc-text">系统部署架构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#部分概念"><span class="toc-number">3.1.</span> <span class="toc-text">部分概念</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#消息发送模式"><span class="toc-number">4.</span> <span class="toc-text">消息发送模式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#同步发送"><span class="toc-number">4.1.</span> <span class="toc-text">同步发送</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#异步发送"><span class="toc-number">4.2.</span> <span class="toc-text">异步发送</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#单向发送"><span class="toc-number">4.3.</span> <span class="toc-text">单向发送</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三种发送方式的对比"><span class="toc-number">4.4.</span> <span class="toc-text">三种发送方式的对比</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#消费模式"><span class="toc-number">5.</span> <span class="toc-text">消费模式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#集群消费模式"><span class="toc-number">5.1.</span> <span class="toc-text">集群消费模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#广播消费模式"><span class="toc-number">5.2.</span> <span class="toc-text">广播消费模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#集群模拟广播消费"><span class="toc-number">5.3.</span> <span class="toc-text">集群模拟广播消费</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#消费类型"><span class="toc-number">6.</span> <span class="toc-text">消费类型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#普通消息"><span class="toc-number">6.1.</span> <span class="toc-text">普通消息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#定时和延时消息"><span class="toc-number">6.2.</span> <span class="toc-text">定时和延时消息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#顺序消息"><span class="toc-number">6.3.</span> <span class="toc-text">顺序消息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#事务消息"><span class="toc-number">6.4.</span> <span class="toc-text">事务消息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#其他特性"><span class="toc-number">7.</span> <span class="toc-text">其他特性</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#消息过滤"><span class="toc-number">7.1.</span> <span class="toc-text">消息过滤</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#消费幂等处理"><span class="toc-number">7.2.</span> <span class="toc-text">消费幂等处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#常见问题："><span class="toc-number">7.3.</span> <span class="toc-text">常见问题：</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(/img/rocketmq.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Hexo</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">RocketMQ</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-06-02 15:03:34"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-06-02</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-06-02 17:30:06"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-06-02</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="什么是RokcetMQ"><a href="#什么是RokcetMQ" class="headerlink" title="什么是RokcetMQ"></a>什么是RokcetMQ</h1><p>消息队列 RocketMQ 版是阿里云基于 Apache RocketMQ 构建的低延迟、高并发、高可用、高可靠的分布式消息中间件。消息队列 RocketMQ 版既可为分布式应用系统提供异步解耦和削峰填谷的能力，同时也具备互联网应用所需的海量消息堆积、高吞吐、可靠重试等特性。</p>
<h1 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h1><ul>
<li><p>削峰填谷</p>
<p>诸如秒杀、抢红包、企业开门红等大型活动时皆会带来较高的流量脉冲，或因没做相应的保护而导致系统超负荷甚至崩溃，或因限制太过导致请求大量失败而影响用户体验，消息队列 RocketMQ 版可提供削峰填谷的服务来解决该问题。</p>
</li>
<li><p>异步解耦</p>
<p>交易系统作为淘宝/天猫主站最核心的系统，每笔交易订单数据的产生会引起几百个下游业务系统的关注，包括物流、购物车、积分、流计算分析等等，整体业务系统庞大而且复杂，消息队列 RocketMQ 版可实现异步通信和应用解耦，确保主站业务的连续性。</p>
</li>
<li><p>顺序收发</p>
<p>细数日常中需要保证顺序的应用场景非常多，例如证券交易过程时间优先原则，交易系统中的订单创建、支付、退款等流程，航班中的旅客登机消息处理等等。与先进先出（First In First Out，缩写 FIFO）原理类似，消息队列 RocketMQ 版提供的顺序消息即保证消息 FIFO。</p>
</li>
<li><p>分布式事务一致性</p>
<p>交易系统、支付红包等场景需要确保数据的最终一致性，大量引入消息队列 RocketMQ 版的分布式事务，既可以实现系统之间的解耦，又可以保证最终的数据一致性。</p>
</li>
<li><p>大数据分析</p>
<p>数据在“流动”中产生价值，传统数据分析大多是基于批量计算模型，而无法做到实时的数据分析，利用阿里云消息队列 RocketMQ 版与流式计算引擎相结合，可以很方便的实现将业务数据进行实时分析。</p>
</li>
<li><p>分布式缓存同步</p>
<p>天猫双 11 大促，各个分会场琳琅满目的商品需要实时感知价格变化，大量并发访问数据库导致会场页面响应时间长，集中式缓存因为带宽瓶颈限制商品变更的访问流量，通过消息队列 RocketMQ 版构建分布式缓存，实时通知商品数据的变化。</p>
</li>
</ul>
<h1 id="系统部署架构"><a href="#系统部署架构" class="headerlink" title="系统部署架构"></a>系统部署架构</h1><p><img src="RocketMQ/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84.png" alt="系统架构"></p>
<p>图中所涉及到的概念如下所述：</p>
<ul>
<li><strong><code>Name Server</code></strong>：是一个几乎无状态节点，可集群部署，在消息队列 RocketMQ 版中提供命名服务，更新和发现 Broker 服务。</li>
<li><code>Broker</code>：消息中转角色，负责存储消息，转发消息。分为 Master Broker 和 Slave Broker，一个 Master Broker 可以对应多个 Slave Broker，但是一个 Slave Broker 只能对应一个 Master Broker。Broker 启动后需要完成一次将自己注册至 Name Server 的操作；随后每隔 30s 定期向 Name Server 上报 Topic 路由信息。</li>
<li><code>生产者（Producer）</code>：与 Name Server 集群中的其中一个节点（随机）建立长链接（Keep-alive），定期从 Name Server 读取 Topic 路由信息，并向提供 Topic 服务的 Master Broker 建立长链接，且定时向 Master Broker 发送心跳。</li>
<li><code>消费者（Consumer）</code>：与 Name Server 集群中的其中一个节点（随机）建立长连接，定期从 Name Server 拉取 Topic 路由信息，并向提供 Topic 服务的 Master Broker、Slave Broker 建立长连接，且定时向 Master Broker、Slave Broker 发送心跳。Consumer 既可以从 Master Broker 订阅消息，也可以从 Slave Broker 订阅消息，订阅规则由 Broker 配置决定。</li>
</ul>
<h2 id="部分概念"><a href="#部分概念" class="headerlink" title="部分概念"></a>部分概念</h2><ul>
<li><p>Topic</p>
<p>消息主题，一级消息类型，通过 Topic 对消息进行分类。</p>
</li>
</ul>
<ul>
<li><p>消息（Message）</p>
<p>消息队列中信息传递的载体。</p>
</li>
</ul>
<ul>
<li><p>Message ID</p>
<p>消息的全局唯一标识，由消息队列 RocketMQ 版系统自动生成，唯一标识某条消息。</p>
</li>
</ul>
<ul>
<li><p>Message Key</p>
<p>消息的业务标识，由消息生产者（Producer）设置，唯一标识某个业务逻辑。</p>
</li>
</ul>
<ul>
<li><p>Tag</p>
<p>消息标签，二级消息类型，用来进一步区分某个 Topic 下的消息分类。</p>
</li>
</ul>
<ul>
<li><p>Producer</p>
<p>消息生产者，也称为消息发布者，负责生产并发送消息。</p>
</li>
</ul>
<ul>
<li><p>Producer 实例</p>
<p>Producer 的一个对象实例，不同的 Producer 实例可以运行在不同进程内或者不同机器上。Producer 实例线程安全，可在同一进程内多线程之间共享。</p>
</li>
</ul>
<ul>
<li><p>Consumer</p>
<p>消息消费者，也称为消息订阅者，负责接收并消费消息。可分为两类：Push Consumer：消息由消息队列 RocketMQ 版推送至 Consumer。Pull Consumer：该类 Consumer 主动从消息队列 RocketMQ 版拉取消息。</p>
</li>
</ul>
<ul>
<li><p>Group</p>
<p>一类 Producer 或 Consumer，这类 Producer 或 Consumer 通常生产或消费同一类消息，且消息发布或订阅的逻辑一致。</p>
</li>
</ul>
<ul>
<li><p>Group ID</p>
<p>Group 的标识。</p>
</li>
</ul>
<ul>
<li><p>队列</p>
<p>每个 Topic 下会由一到多个队列来存储消息。 </p>
</li>
</ul>
<h1 id="消息发送模式"><a href="#消息发送模式" class="headerlink" title="消息发送模式"></a>消息发送模式</h1><h2 id="同步发送"><a href="#同步发送" class="headerlink" title="同步发送"></a>同步发送</h2><p>发送重要通知时使用。</p>
<p>消息发送方发出一条消息后，会在收到服务端返回响应之后才发下一条消息</p>
<p><img src="/RocketMQ/%E5%90%8C%E6%AD%A5%E5%8F%91%E9%80%81.png" alt="同步发送"></p>
<h2 id="异步发送"><a href="#异步发送" class="headerlink" title="异步发送"></a>异步发送</h2><p>对时间有要求，发布者不能长时间等待broker回应，消息发送方在发送了一条消息后，不需要等待服务端响应即可发送第二条消息。发送方通过回调接口接收服务端响应，并处理响应结果。</p>
<p>场景：例如用户视频上传后通知启动转码服务，转码完成后通知推送转码结果等。</p>
<p><img src="/RocketMQ/%E5%BC%82%E6%AD%A5%E5%8F%91%E9%80%81.png" alt="同步发送"></p>
<h2 id="单向发送"><a href="#单向发送" class="headerlink" title="单向发送"></a>单向发送</h2><p>发送方只负责发送消息，不等待服务端返回响应且没有回调函数触发，即只发送请求不等待应答。此方式发送消息的过程耗时非常短，一般在微秒级别。</p>
<p>场景：适用于某些耗时非常短，但对可靠性要求并不高的场景，例如日志收集。</p>
<p><img src="/RocketMQ/%E5%8D%95%E5%90%91%E5%8F%91%E9%80%81.png" alt="单向发送"></p>
<h2 id="三种发送方式的对比"><a href="#三种发送方式的对比" class="headerlink" title="三种发送方式的对比"></a>三种发送方式的对比</h2><table>
<thead>
<tr>
<th>发送方式</th>
<th>发送 TPS</th>
<th>发送结果反馈</th>
<th>可靠性</th>
</tr>
</thead>
<tbody><tr>
<td>同步发送</td>
<td>快</td>
<td>有</td>
<td>不丢失</td>
</tr>
<tr>
<td>异步发送</td>
<td>快</td>
<td>有</td>
<td>不丢失</td>
</tr>
<tr>
<td>单向发送</td>
<td>最快</td>
<td>无</td>
<td>可能丢失</td>
</tr>
</tbody></table>
<h1 id="消费模式"><a href="#消费模式" class="headerlink" title="消费模式"></a>消费模式</h1><p><code>集群概念</code>：使用同一个GroupId的消费者属于同一个集群。他们的订阅逻辑必须一致。</p>
<h2 id="集群消费模式"><a href="#集群消费模式" class="headerlink" title="集群消费模式"></a>集群消费模式</h2><p>任意一条消息只需要被集群内的任意一个消费者处理即可。但不能保证失败重投的消息到同一台机器上。</p>
<p><img src="/RocketMQ/%E9%9B%86%E7%BE%A4%E5%8F%91%E9%80%81%E6%A8%A1%E5%BC%8F.png" alt="集群发送模式"></p>
<h2 id="广播消费模式"><a href="#广播消费模式" class="headerlink" title="广播消费模式"></a>广播消费模式</h2><p>每条消息都要推送给集群内所有注册过的consumer，并且保证每个consumer消费一次。</p>
<p>不支持顺序消息，不支持消费重投。若客户端被重启，在此期间的消息都会被跳过，重启后消费最新消息。</p>
<p><img src="/RocketMQ/%E5%B9%BF%E6%92%AD%E5%8F%91%E9%80%81%E6%A8%A1%E5%BC%8F.png" alt="广播发送模式"></p>
<h2 id="集群模拟广播消费"><a href="#集群模拟广播消费" class="headerlink" title="集群模拟广播消费"></a>集群模拟广播消费</h2><p>适用于每条消息都需要被多台机器处理，每台机器的逻辑可以相同也可以不一样的场景。</p>
<p><img src="/RocketMQ/%E9%9B%86%E7%BE%A4%E5%B9%BF%E6%92%AD.png" alt="集群广播"></p>
<p>对于一个 Group ID 来说，可以部署一个消费者实例，也可以部署多个消费者实例。当部署多个消费者实例时，实例之间又组成了集群模式（共同分担消费消息）。假设 Group ID 1 部署了三个消费者实例 C1、C2、C3，那么这三个实例将共同分担服务器发送给 Group ID 1 的消息。同时，实例之间订阅关系必须保持一致</p>
<h1 id="消费类型"><a href="#消费类型" class="headerlink" title="消费类型"></a>消费类型</h1><h2 id="普通消息"><a href="#普通消息" class="headerlink" title="普通消息"></a>普通消息</h2><p>毫无特性的消息</p>
<h2 id="定时和延时消息"><a href="#定时和延时消息" class="headerlink" title="定时和延时消息"></a>定时和延时消息</h2><p>定时是在某个时间点推送，延时是延迟一段时间推送，最终效果相同，代码存在差异</p>
<p>适用场景：30分钟的支付订单，未支付则关闭订单</p>
<p>触发一些定时任务，某个固定时刻给用户发送信息</p>
<p>发送定时消息需要明确指定消息发送时间点之后的某一时间点作为消息投递的时间点。</p>
<p>发送延时消息时需要设定一个延时时间长度，消息将从当前发送时间点开始延迟固定时间之后才开始投递</p>
<h2 id="顺序消息"><a href="#顺序消息" class="headerlink" title="顺序消息"></a>顺序消息</h2><p>顺序消息分为两类：</p>
<p><code>全局顺序</code>：对于指定的一个 Topic，所有消息按照严格的先入先出（First In First Out，简称FIFO）的顺序进行发布和消费。</p>
<p><code>分区顺序</code>：对于指定的一个 Topic，所有消息根据 Sharding Key 进行区块分区。 同一个分区内的消息按照严格的FIFO 顺序进行发布和消费。Sharding Key 是顺序消息中用来区分不同分区的关键字段，和普通消息的 Key 是完全不同的概念。</p>
<p>示例：</p>
<p>用户注册需要发送发验证码，以用户 ID 作为 ShardingKey，那么同一个用户发送的消息都会按照发布的先后顺序来消费。</p>
<p>电商的订单创建，以订单 ID 作为 ShardingKey，那么同一个订单相关的创建订单消息、订单支付消息、订单退款消息、订单物流消息都会按照发布的先后顺序来消费。</p>
<p><strong><code>顺序消息不支持事务和延时，也不支持异步和单向</code></strong></p>
<table>
<thead>
<tr>
<th>Topic 的消息类型</th>
<th>是否支持事务消息</th>
<th>是否支持定时/延时消息</th>
<th>性能</th>
</tr>
</thead>
<tbody><tr>
<td>无序消息（普通、事务、定时/延时消息）</td>
<td>是</td>
<td>是</td>
<td>最高</td>
</tr>
<tr>
<td>分区顺序消息</td>
<td>否</td>
<td>否</td>
<td>高</td>
</tr>
<tr>
<td>全局顺序消息</td>
<td>否</td>
<td>否</td>
<td>一般</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>消息类型</th>
<th>是否支持可靠同步发送</th>
<th>是否支持可靠异步发送</th>
<th>是否支持 Oneway 发送</th>
</tr>
</thead>
<tbody><tr>
<td>无序消息（普通、事务、定时/延时消息）</td>
<td>是</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>分区顺序消息</td>
<td>是</td>
<td>否</td>
<td>否</td>
</tr>
<tr>
<td>全局顺序消息</td>
<td>是</td>
<td>否</td>
<td>否</td>
</tr>
</tbody></table>
<p>注意事项：建议一个groupid只有一个topic，顺序和无序消息分开</p>
<p>运行多个实例，消息不会有堵塞，一个实例退出时，其他实例可以立即接手。实际工作只有一个实例</p>
<h2 id="事务消息"><a href="#事务消息" class="headerlink" title="事务消息"></a>事务消息</h2><p>通过消息队列RocketMQ 事务消息能达到分布式事务的最终一致。</p>
<p><code>半事务消息</code>：暂不能投递的消息，发送方已经成功地将消息发送到了消息队列 RocketMQ<br>版服务端，但是服务端未收到生产者对该消息的二次确认，此时该消息被标记成“暂不能投递”状态，处于该种状态下的消息即半事务消息。</p>
<p><code>消息回查</code>：由于网络闪断、生产者应用重启等原因，导致某条事务消息的二次确认丢失，消息队列<br>RocketMQ 版服务端通过扫描发现某条消息长期处于“半事务消息”时，需要主动向消息生产者询问该消息的最终状态（Commit 或是<br>Rollback），该询问过程即消息回查。</p>
<p><code>优势：</code></p>
<ol>
<li><p>应用之间解耦，保证数据一致性。</p>
</li>
<li><p>大事务拆分小事务，不会因为一个应用失败导致整体回滚。</p>
</li>
<li><p>极端情况下，某个应用始终无法成功，也只需对当前应用进行补偿或数据订正处理，而无需对整体业务进行回滚。</p>
<p>​</p>
</li>
</ol>
<p><img src="/RocketMQ/%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF%E7%9A%84%E4%BC%98%E5%8A%BF.png" alt=""></p>
<p><strong>事务消息交互流程</strong></p>
<p><img src="/RocketMQ/%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF%E4%BA%A4%E4%BA%92%E6%B5%81%E7%A8%8B.png" alt="事务消息交互流程"></p>
<p><code>发送流程:</code></p>
<ol>
<li>消息发送方，发送半事务消息 给服务端</li>
<li>服务端将此条半事务消息持久化，并向发送方返回确认消息，通知其发送成功。此时消息为半事务消息。</li>
<li>消息发送方收到服务的确认消息，开始执行本地事务。</li>
<li>事务执行完毕后，向服务端发送执行状态（commit或者rollback）。服务端接受到commit状态，将此前的半事务消息标记为可投递，消息订阅方收到消息。接收到rollback状态，不投递消息（存储三天删除）</li>
</ol>
<p><code>回查流程:</code></p>
<ol>
<li>某些情况下，服务端未收到commit或者rollback消息，经过一段时间后，对该消息发起回查。</li>
<li>消息发送方收到后，查询该条消息对应事务的最终执行结果</li>
<li>得到最终结果后，发送消息给服务端，继续按照步骤4进行操作</li>
</ol>
<p><code>注意事项：</code></p>
<ol>
<li>事务消息的 Group ID 不能与其他类型消息的 Group ID 共用。与其他类型的消息不同，事务消息有回查机制，回查时消息队列 RocketMQ 版服务端会根据 Group ID 去查询客户端。</li>
<li>本地事务有3种状态  提交事务 / 回滚事务 /暂时无法判定，等待回查。</li>
</ol>
<h1 id="其他特性"><a href="#其他特性" class="headerlink" title="其他特性"></a>其他特性</h1><h2 id="消息过滤"><a href="#消息过滤" class="headerlink" title="消息过滤"></a>消息过滤</h2><p>利用tag订阅   </p>
<p>单个：taga   </p>
<p>多个：taga||tagb</p>
<p>注意：多次订阅以最后一次为准</p>
<h2 id="消费幂等处理"><a href="#消费幂等处理" class="headerlink" title="消费幂等处理"></a>消费幂等处理</h2><p>保证多次消费，只有一次结果，一条记录</p>
<p>通过设置业务的唯一标识，可以通过消息Key 设置</p>
<p>订阅关系一致</p>
<p>同一个groupId的下的consumer实例，实现逻辑必须一致</p>
<p>保持订阅关系一致意味着同一个消费者 Group ID中多个消费者实例订阅的Topic必须一致，Topic中的tag必须一致</p>
<h2 id="常见问题："><a href="#常见问题：" class="headerlink" title="常见问题："></a>常见问题：</h2><p>顺序消息、定时消息、事务消息是不同的消息类型，三者是互斥关系，不能叠加在一起使用</p>
<p>顺序消息暂时仅支持集群消费模式，顺序消息只支持可靠同步发送方式，不支持异步发送方式，否则将无法严格保证顺序。不支持广播消费模式。</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">zangaihu</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yoursite.com/2020/06/02/RocketMQ/">http://yoursite.com/2020/06/02/RocketMQ/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yoursite.com" target="_blank">Hexo</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/RocketMQ/">RocketMQ</a><a class="post-meta__tags" href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a><a class="post-meta__tags" href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a></div><div class="post_share"><div class="social-share" data-image="/img/rocketmq.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="next-post pull-full"><a href="/2020/05/25/MongoDB%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C/"><img class="next_cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">MongoDB基本操作</div></div></a></div></nav><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '5272c7a403fca395',
  clientSecret: '8ffa1a66aac9bc77693796c4dbf41f26d567ce36',
  repo: 'https://github.com/zangaihu/blogcomment',
  owner: 'zangaihu',
  admin: ['zangaihu'],
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN',
  perPage: 10,
  distractionFreeMode: false,
  pagerDirection: 'last',
  createIssueManually: false,
  updateCountCallback: commentCount
})
gitalk.render('gitalk-container')

function commentCount(n){
  try {
    document.getElementsByClassName('gitalk-comment-count')[0].innerHTML= n
  } catch (e) {
    return false
  }
}</script></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By zangaihu</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode far fa-moon" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script id="ribbon_piao" mobile="false" src="/js/third-party/piao.js"></script><script id="canvas_nest" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="/js/third-party/canvas-nest.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script></body></html>